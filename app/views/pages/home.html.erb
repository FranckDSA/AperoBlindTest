<%= simple_form_for :player, url: players_path, defaults: {label: false} do |f| %>
  <%= f.input :game_pin_entered %>
  <%= f.input :user_name %>
  <%= f.submit "Enter the Game!", class: "" %>
<% end %>


<%= link_to "Create a new game", omniauth_authorize_path(:user, :spotify) %>


  <h1>APERO BLIND TEST</h1>
  <h2>Current playlist: <%=Game.first.playlist.name%></h2>
  <img src="<%=Game.first.playlist.image%>" alt="" style="width: 200px">

  <div class="current-track" style="color:blue">
    <h2>Current track:<%=Game.first.tracks.first.title%></h2>
    <img src="<%=Game.first.tracks.first.image%>" alt="" style="width: 200px">
  </div>

  <button type="button" class="btn btn-primary" id="pause">Pause</button>
  <button type="button" class="btn btn-primary" id="resume">Resume</button>
  <button type="button" class="btn btn-primary" id="nexttrack">Next track</button>
  <button type="button" class="btn btn-primary" id="end">End Game</button>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = '<%= current_user.token %>';
      const player = new Spotify.Player({
        name: 'AperoBlindTests',
        getOAuthToken: cb => { cb(token);}
      });

      // Error handling
      player.addListener('initialization_error', ({ message }) => { console.error(message); });
      player.addListener('authentication_error', ({ message }) => { console.error(message); });
      player.addListener('account_error', ({ message }) => { console.error(message); });
      player.addListener('playback_error', ({ message }) => { console.error(message); });

      // Playback status updates
      player.addListener('player_state_changed', state => { console.log(state); });

      // Ready
      player.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
        const id = "34FbkFgAbv4ffvhL2XQMVm";
        "<%= Game.first.playlist.name%>"
        play({
          playerInstance: player,
          spotify_uri: `spotify:track:${id}`,
        });
      });

      // Not Ready
      player.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
      });

      // Connect to the player!
      player.connect();


      const play = ({
        spotify_uri,
        playerInstance: {
          _options: {
            getOAuthToken,
            id
          }
        }
      }) => {
        getOAuthToken(access_token => {
          fetch(`https://api.spotify.com/v1/me/player/play?device_id=${id}`, {
            method: 'PUT',
            body: JSON.stringify({ uris: [spotify_uri] }),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${access_token}`
            },
          });
        });
      };

      const button_pause = document.querySelector('#pause');
      button_pause.addEventListener('click', () => {
        player.pause().then(() => {
          console.log('Paused!');
        });
      });

      const button_resume = document.querySelector('#resume');
      button_resume.addEventListener('click', () => {
        player.resume().then(() => {
          console.log('Resumed!');
        });
      });

      const button_nexttrack = document.querySelector('#nexttrack');
      button_nexttrack.addEventListener('click', () => {
        player.nextTrack().then(() => {
          console.log('Skipped to next track!');
        });
      });

      const button_endgame = document.querySelector('#end');
      button_endgame.addEventListener('click', () => {
        player.disconnect()
      });

};
  </script>


